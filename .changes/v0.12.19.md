v0.12.19 Pre-Release - 2026-02-01

**该版本变动很大，请谨慎升级，由于测试不是很全面可能碰到各种bug，遇到问题请及时反馈**
**由于大改了115 openapi客户端，现在使用神医提取媒体信息时如果开的线程太多会导致所有其他任务都无法执行（表现为卡住）**

- 重构STRM同步的数据结构，省流版：内存表代替临时表，errgroup+递归代替waitgroup+循环，优化115同步架构，提升同步性能，减少内存泄露和协程阻塞的风险，具体改动：
  - 去掉临时表，改为使用内存临时表（自定义数据结构+自己实现的表处理逻辑）来存放本次同步的详情，5万个文件内存占用大概多50MB左右
  - 同步过程中产生的下载任务，先不实际添加到下载队列，在网盘文件同步完成后，统一处理，避免频繁操作下载队列带来的性能损耗
  - 本地文件（主要指CD2挂载）和openlist使用一套同步架构，使用errgroup并发处理+递归调用代替以前的waitgroup+循环处理，默认并发数为10
  - 115依然维持预缓存2层目录结构+批量获取文件列表+并发补全目录的架构设计，但是使用errgroup并发处理+递归调用代替以前的waitgroup+循环处理
    - 预缓存2层目录结构只有在首次同步或者全量同步时启用；同步前会先查询一个文件，然后根据文件的路径和入口目录的层级差来计算目录深度，如果深度大于2或小于1则跳过预缓存目录（因为没有收益，比如电视剧哪怕同步了电视剧列表依然无法处理Season 1这种目录，但是如果缓存到了电影列表，那么电影下的文件基本不用再补充路径了）
    - 批量获取文件是通过115的文件列表先将所有文件查询并且缓存，这样可以快速的获取到115的全量文件，10万文件大概只需要30秒左右
    - 获取全量文件列表后再批量处理，对于没有路径的文件，调用115文件详情接口补全路径，使用errgroup并发处理，先将所有缓存的文件的父目录ID分组去重，然后再一个一个处理。
  - STRM同步任务开始时会先暂停上传和下载队列，任务完成后再启动上传和下载队列，避免同步过程中上传下载任务抢占资源导致同步变慢的问题

- 重构115 openapi客户端：
  - 所有请求采用一套同步队列，先进先出，避免恶性竞争导致某些请求一直无法返回，其他协程一直阻塞的问题。
  - 如果某个请求收到了限流响应，则暂停所有请求一段时间再继续（一般为1分钟），避免频繁请求导致的限流加重问题（如果限流后依然请求，会加大限流时间，可能最长为24小时无法使用接口）。
  - 记录请求量，提供接口查看一段时间内的qps,qpm,qph,限流请求数，限流等待时间，每隔请求的响应时间、平均响应时间等数据，方便调试和优化请求频率。
  - 播放请求依然不限流，但是如果其他请求发生了限流，则播放请求也会暂停一段时间再继续（播放主要指获取下载链接，如果已经有了下载链接则不影响，下载链接会缓存2个小时）。

- 修正重试上传任务时没有清空上一次失败原因的问题
- 暂时关闭数据库备份模块（备份文件有问题，无法恢复），后续会重新设计该模块
- 首页新增115请求统计模块，可以直观看到115当前是否限流以及按小时的请求量、平均响应时间等统计，方便调整接口QPS
- 移除不使用的数据表：sync115_path, backup_task, restore_task, sync_files_cache
- 更新了docker入口脚本，现在可以优雅的关闭镜像了（老版本关闭镜像要等很久）
- windows将config目录和postgres数据库二进制文件迁移到%APPDATA%\QMediaSync目录下，避免程序目录权限不足的问题
  - config/.env和config/server.crt,server.key会保留在原有位置（程序目录下的config），方便添加证书和修改环境变量
  - 原有的config/logs, config/postgres, config/backups, config/tmp, config/db.db.bak, config/custom-css, config/custom-js不会自动删除，如果需要可以手动删除（仅限windows系统）
- 修复下载任务被加入下载队列时可能不会显示为下载中的问题
- 修复下载任务由于没有115文件ID而无法下载的问题
- 修复下载任务没有在加入队列时设置为下载中导致重复添加下载任务的问题
- 修复下载队列停止后无法重新启动的问题，日志记录如下： 
```
panic: send on closed channel
goroutine 233 [running]:
Q115-STRM/internal/models.(*DQ).moveTasksToChannel(0xc000238e40)
        /app/internal/models/download.go:217 +0x345
Q115-STRM/internal/models.(*DQ).taskScheduler(0xc000238e40)
        /app/internal/models/download.go:169 +0x6f
created by Q115-STRM/internal/models.(*DQ).Start in goroutine 90
        /app/internal/models/download.go:83 +0x1cf
主进程退出，等待更新完成...
主进程退出，未检测到更新文件，退出容器...
```